{% extends "base.html" %}
{% load humanize %}

<!-- This sets the page title -->
{% block title %}EVE Waitlist - View{% endblock %}


<!-- These styles are specific to the waitlist view -->
{% block styles %}
<style>
    .waitlist-container {
        display: flex;
        flex-direction: row;
        gap: 10px;
        padding: 10px;
        /* Allow horizontal scrolling on small screens */
        overflow-x: auto;
        /* Set a height so vertical scrollbars appear inside columns */
        height: calc(100vh - var(--header-height) - 20px); /* Full height minus header */
    }

    .waitlist-column {
        flex: 1 0 300px; /* Flex-grow, flex-shrink, flex-basis (min-width) */
        min-width: 300px;
        max-width: 340px;
        display: flex;
        flex-direction: column;
        background: #2a2a2a;
        border-radius: 8px;
        /* Handle vertical overflow */
        height: 100%;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 2px solid #444;
    }

        .column-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: #fff;
        }

    .column-count {
        font-size: 1.2em;
        font-weight: bold;
        background: #444;
        color: #fff;
        padding: 2px 8px;
        border-radius: 5px;
    }

    /* Column Header Colors */
    .status-PENDING {
        border-top: 3px solid #ffc107;
    }

    .status-APPROVED {
        border-top: 3px solid #28a745;
    }

    .fit-card-list {
        list-style: none;
        padding: 10px;
        margin: 0;
        /* Make the list scrollable, not the whole column */
        overflow-y: auto;
        height: 100%;
    }

        /* Scrollbar styling */
        .fit-card-list::-webkit-scrollbar {
            width: 8px;
        }

        .fit-card-list::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }

        .fit-card-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

            .fit-card-list::-webkit-scrollbar-thumb:hover {
                background: #666;
            }


    .fit-card {
        background: #333;
        border: 1px solid #444;
        border-radius: 5px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-bottom: 1px solid #444;
    }

    .pilot-portrait {
        width: 48px;
        height: 48px;
        border-radius: 5px;
        border: 1px solid #555;
    }

    .pilot-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #fff;
        /* Prevent long names from breaking layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- NEW: Wait Timer Style --- */
    .wait-timer {
        font-size: 0.8em;
        font-weight: bold;
        color: #ffc107; /* Yellow */
        margin-left: auto;
        padding: 2px 6px;
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
    }

    .card-body {
        padding: 10px;
        font-size: 0.9em;
    }

    /* --- NEW: Layout for fit info + ship image --- */
    .card-body-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .card-fit-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Take up available space */
        min-width: 0; /* Allow shrinking */
    }

    .ship-image-container {
        flex-shrink: 0; /* Don't shrink */
        /* --- NEW: Add cursor for clickable --- */
        cursor: pointer;
        border-radius: 5px;
        padding: 4px;
        transition: background-color 0.2s;
    }

        .ship-image-container:hover {
            background-color: #444;
        }

        .ship-image-container img {
            width: 64px;
            height: 64px;
            display: block; /* Remove bottom space */
        }
    /* --- END NEW --- */


    .fit-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        /* --- MODIFIED: Justify left --- */
        justify-content: flex-start;
        gap: 5px;
    }

        .fit-info strong {
            color: #aaa;
            flex-shrink: 0;
        }

        .fit-info .placeholder {
            color: #ddd;
            font-weight: 500;
            /* --- Allow text to wrap --- */
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            /* --- Justify left --- */
            text-align: left;
        }

    .fit-issues {
        margin-top: 8px;
        font-size: 0.85em;
    }

        .fit-issues strong {
            color: #ffc107;
        }
        /* Yellow */
        .fit-issues .placeholder {
            color: #ffc107;
        }

    .pilot-stats {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #444;
        display: flex;
        justify-content: space-around;
        font-size: 0.8em;
    }

    .stat-item {
        text-align: center;
    }

        .stat-item strong {
            color: #aaa;
        }

        .stat-item .placeholder {
            color: #ddd;
            font-weight: 600;
        }

    /* --- NEW: FC Action Bar --- */
    .fc-actions {
        display: flex;
        gap: 5px;
        border-top: 1px solid #444;
        padding: 8px 10px 5px 10px;
        margin-top: 10px;
        /* --- MODIFIED: Align buttons to the right --- */
        justify-content: flex-end;
    }

    .fc-btn {
        background: #555;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        padding: 5px 8px;
        /* --- MODIFIED: Slightly larger emoji --- */
        font-size: 1.1em;
        line-height: 1;
        transition: background-color 0.2s, transform 0.1s;
    }

        .fc-btn:hover {
            transform: scale(1.1);
        }

        .fc-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    .btn-approve {
        background-color: #28a745;
    }

        .btn-approve:hover {
            background-color: #34c254;
        }

    .btn-deny {
        background-color: #dc3545;
    }

        .btn-deny:hover {
            background-color: #e64a58;
        }


    .waitlist-closed-msg {
        color: #aaa;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
</style>
{% endblock %}


{% block content %}
<!--
This container will be the target for our live polling.
It will be filled by the partial template on page load.
-->
<div class="waitlist-container" id="waitlist-container-live">
    {% include "_waitlist_columns.html" %}
</div>
{% endblock %}


<!-- --- NEW JAVASCRIPT BLOCK --- -->
{% block scripts %}
<script>
    // This script block will handle both FC actions and the new timer/polling

    // --- CSRF Token for all API requests ---
    const csrfToken = "{{ csrf_token }}";

    // --- Check if user is an FC ---
    const isFC = {{ is_fc|yesno:"true,false" }};

    // --- 1. FC ACTION HANDLER ---

    function handleFCAction(event) {
        // Find the button that was clicked
        const button = event.target.closest('.fc-btn');
        if (!button) return; // Click wasn't on a button

        const fitId = button.dataset.fitId;
        const action = button.dataset.action;
        const card = document.getElementById(`fit-card-${fitId}`);

        // Disable all buttons on this card to prevent double-clicks
        card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = true);

        const formData = new FormData();
        formData.append('fit_id', fitId);
        formData.append('action', action);

        fetch("{% url 'waitlist:api_update_fit_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // --- FIX: Only remove on 'deny' ---
                // Let the poller handle moving 'approved' fits
                if (action === 'deny') {
                    card.remove();
                } else {
                    // Optional: show a temporary "approved" state
                    // For now, we just leave buttons disabled
                }
                // --- END FIX ---
            } else {
                // Re-enable buttons on failure
                card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            // Re-enable buttons on failure
            card.querySelectorAll('.fc-btn').forEach(btn => btn.disabled = false);
            alert(`Network Error: ${error.message}`);
        });
    }

    // --- 2. TIMER AND LIVE POLLING ---

    const waitlistContainer = document.getElementById('waitlist-container-live');
    let pollingInterval = null;
    let timerInterval = null;

    // This function updates all timers on the page
    function updateWaitTimers() {
        const fitCards = waitlistContainer.querySelectorAll('.fit-card');
        const now = new Date();

        fitCards.forEach(card => {
            const timerEl = card.querySelector('.wait-timer');
            const submittedTime = new Date(card.dataset.submittedTime);

            const diffMs = now - submittedTime;
            const diffMins = Math.floor(diffMs / 60000); // Total minutes

            if (timerEl) {
                timerEl.textContent = `${diffMins}m`;
            }
        });
    }

    // This function fetches the new HTML
    function fetchWaitlistHTML() {
        fetch("{% url 'waitlist:api_get_waitlist_html' %}")
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Waitlist closed or error');
            })
            .then(html => {
                // --- This is the key: replace the content ---
                waitlistContainer.innerHTML = html;

                // After redrawing, re-update the timers immediately
                updateWaitTimers();
            })
            .catch(error => {
                // Waitlist is probably closed
                waitlistContainer.innerHTML = `<p class="waitlist-closed-msg">Waitlist is currently closed. The page will refresh when it opens.</p>`;
            });
    }

    // --- 3. NEW: FIT DETAIL MODAL HANDLER ---

    // Get modal elements (they are in base.html)
    const fitModalOverlay = document.getElementById('fit-detail-modal-overlay');
    const fitModalCloseBtn = document.getElementById('fit-detail-modal-close-btn');
    const fitModalCancelBtn = document.getElementById('fit-detail-modal-cancel-btn');
    const fitModalBody = document.getElementById('fit-detail-modal-body');
    const fitModalTitle = document.getElementById('fit-detail-modal-title');

    function openFitModal(fitId) {
        if (!fitModalOverlay) return;

        // Show modal with spinner
        fitModalBody.innerHTML = '<div class="modal-spinner"></div>';
        fitModalTitle.textContent = "Loading Fit...";
        fitModalOverlay.classList.add('show');

        // Fetch fit details
        fetch(`{% url 'waitlist:api_get_fit_details' %}?fit_id=${fitId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load fit details.');
                }
                return response.json();
            })
            .then(data => {
                // --- MODIFICATION: Handle new JSON structure ---
                // data = { problem_items: [], missing_items: [], doctrine_name: "..." }

                fitModalTitle.textContent = `Fit vs. ${data.doctrine_name}`;

                let html = '<div class="fit-modal-sub-container">';

                // --- Build Problem Items List ---
                html += '<div>';
                html += '<h3 class="fit-modal-sub-header header-problem">Problem Items</h3>';
                html += '<ul class="fit-modal-sub-list">';
                if (data.problem_items.length > 0) {
                    data.problem_items.forEach(item => {
                        html += `<li class="fit-modal-sub-item" id="sub-item-${item.type_id}">`;
                        if (item.icon_url) {
                            html += `<img src="${item.icon_url}" alt="${item.name}">`;
                        } else {
                            html += '<div class="fit-modal-icon-placeholder"></div>';
                        }
                        html += `<span title="${item.raw_line}">${item.name} (x${item.quantity})</span>`;

                        // Add "Make Sub" button only if there are missing items to map to
                        if (data.missing_items.length > 0) {
                            html += `<button class="btn-make-sub js-make-sub"
                                        data-sub-item-id="${item.type_id}"
                                        data-sub-item-name="${item.name}">
                                        Make Sub
                                    </button>`;
                        }
                        html += '</li>';
                    });
                } else {
                    html += '<li style="color: #999; font-style: italic;">None</li>';
                }
                html += '</ul></div>';

                // --- Build Missing Items List ---
                html += '<div>';
                html += '<h3 class="fit-modal-sub-header header-missing">Missing Items</h3>';
                html += '<ul class="fit-modal-sub-list">';
                if (data.missing_items.length > 0) {
                    data.missing_items.forEach(item => {
                        html += `<li class="fit-modal-sub-item">`;
                        if (item.icon_url) {
                            html += `<img src="${item.icon_url}" alt="${item.name}">`;
                        } else {
                            html += '<div class="fit-modal-icon-placeholder"></div>';
                        }
                        html += `<span>${item.name} (x${item.quantity})</span>`;
                        html += '</li>';
                    });
                } else {
                    html += '<li style="color: #999; font-style: italic;">None</li>';
                }
                html += '</ul></div>';

                html += '</div>'; // Close .fit-modal-sub-container

                fitModalBody.innerHTML = html;

                // --- Add event listeners for the new buttons ---
                // We must do this *after* setting innerHTML
                fitModalBody.querySelectorAll('.js-make-sub').forEach(button => {
                    button.addEventListener('click', () => {
                        showSubstitutionDropdown(button, data.missing_items);
                    });
                });

            })
            .catch(error => {
                fitModalBody.innerHTML = `<p style="color: #ff8a8a; padding: 20px;">Error: ${error.message}</p>`;
            });
    }

    function closeFitModal() {
        if (fitModalOverlay) {
            fitModalOverlay.classList.remove('show');
        }
    }

    // --- NEW: Function to show the "Make Sub" dropdown ---
    function showSubstitutionDropdown(button, missingItems) {
        // Get data from the clicked button
        const substituteItemId = button.dataset.subItemId;
        const substituteItemName = button.dataset.subItemName;

        // Find the parent list item
        const listItem = button.closest('.fit-modal-sub-item');
        if (!listItem) return;

        // Disable the button to prevent double clicks
        button.disabled = true;

        // Create the dropdown
        const select = document.createElement('select');
        select.className = 'sub-dropdown-select';

        // Add a placeholder option
        select.innerHTML = `<option value="">Substitute for...</option>`;

        // Add all missing items as options
        missingItems.forEach(item => {
            select.innerHTML += `<option value="${item.type_id}">${item.name} (x${item.quantity})</option>`;
        });

        // Add an event listener to the dropdown
        select.addEventListener('change', () => {
            const baseItemId = select.value;
            if (!baseItemId) return;

            // Get the name of the selected base item
            const baseItemName = select.options[select.selectedIndex].text;

            // Show a simple confirm dialog
            if (!confirm(`Add "${substituteItemName}" as a substitute for "${baseItemName}"?`)) {
                // User cancelled
                select.remove(); // Remove the dropdown
                button.disabled = false; // Re-enable button
                return;
            }

            // User confirmed, send the API request
            const formData = new FormData();
            formData.append('base_item_id', baseItemId);
            formData.append('substitute_item_id', substituteItemId);

            fetch("{% url 'waitlist:api_add_substitution' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message); // Show success
                    // Remove the dropdown
                    select.remove();
                    // Keep the button disabled, or maybe change its text
                    button.textContent = "Added!";
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
                select.remove(); // Remove dropdown
                button.disabled = false; // Re-enable button on error
            });
        });

        // Add the dropdown to the list item
        listItem.appendChild(select);
    }


    // Add close listeners for the modal
    if (fitModalOverlay) {
        fitModalCloseBtn.addEventListener('click', closeFitModal);
        fitModalCancelBtn.addEventListener('click', closeFitModal);
        fitModalOverlay.addEventListener('click', (e) => {
            if (e.target === fitModalOverlay) {
                closeFitModal();
            }
        });
    }


    // This function sets up all our event listeners
    function initializeWaitlist() {

        // --- 4. MODIFIED: Add event delegation ---
        waitlistContainer.addEventListener('click', (event) => {
            // Check for FC action click
            const fcButton = event.target.closest('.fc-btn');
            if (isFC && fcButton) {
                handleFCAction(event);
                return; // Stop processing
            }

            // Check for Fit Modal click
            const fitModalButton = event.target.closest('.js-open-fit-modal');
            if (isFC && fitModalButton) {
                const fitId = fitModalButton.dataset.fitId;
                openFitModal(fitId);
                return; // Stop processing
            }
        });
        // --- END MODIFICATION ---

        // Run timers
        updateWaitTimers(); // Run once on load
        if (timerInterval) clearInterval(timerInterval); // Clear old timer
        timerInterval = setInterval(updateWaitTimers, 10000); // Update timers every 10s

        // Start live polling
        if (pollingInterval) clearInterval(pollingInterval); // Clear old poller
        pollingInterval = setInterval(fetchWaitlistHTML, 5000); // Poll every 5s
    }

    // --- 5. PAGE INITIALIZATION ---

    document.addEventListener('DOMContentLoaded', () => {
        // Enable the X-Up button (it's disabled by default in base.html)
        // We do this here so it's only enabled if the page loads correctly.
        const xupButton = document.getElementById('xup-modal-button');
        const openWaitlist = {{ open_waitlist.pk|default:"null" }};

        if (xupButton && openWaitlist !== null) {
            xupButton.disabled = false;
        }

        // Start all the interactive parts
        initializeWaitlist();
    });

</script>
{% endblock %}