{% extends "base.html" %}
{% load humanize %}
{% block title %}EVE Waitlist - View{% endblock %}

<!--
FIX: These styles are now wrapped in their own <style> tag
so they can be correctly injected into the base.html <head>.
-->
{% block styles %}
<style>
    /* --- GRID LAYOUT --- */
    .waitlist-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        padding: 20px;
        max-width: 100%;
        box-sizing: border-box;
    }

    .waitlist-column {
        background: #2a2a2a;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        /* Min-height ensures empty columns still appear */
        min-height: 200px;
        display: flex;
        flex-direction: column;
    }

    /* --- COLUMN HEADER --- */
    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid #444;
        border-radius: 8px 8px 0 0;
    }

        .column-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: #fff;
        }

    .column-count {
        font-size: 1.1em;
        font-weight: bold;
        background: #333;
        color: #fff;
        padding: 4px 10px;
        border-radius: 5px;
    }
    /* Header colors */
    .status-PENDING {
        background-color: #a67c00;
    }

    .status-APPROVED {
        background-color: #339966;
    }

    .status-IN_FLEET {
        background-color: #3b5998;
    }


    /* --- FIT CARD LIST --- */
    .fit-card-list {
        list-style: none;
        padding: 10px;
        margin: 0;
        /* Make the list fill the column */
        flex-grow: 1;
    }

    /* --- FIT CARD --- */
    .fit-card {
        background: #333;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

        .fit-card.status-PENDING {
            border-left: 4px solid #a67c00;
        }

        .fit-card.status-APPROVED {
            border-left: 4px solid #339966;
        }

        .fit-card.status-IN_FLEET {
            border-left: 4px solid #3b5998;
        }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #444;
    }

    .pilot-portrait {
        width: 48px;
        height: 48px;
        border-radius: 5px;
    }

    .pilot-name {
        font-size: 1.1em;
        font-weight: 600;
        color: #fff;
        /* Allow name to shrink but not grow */
        flex-shrink: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- NEW: Wait Timer --- */
    .wait-timer {
        font-size: 0.9em;
        font-weight: 600;
        color: #ccc;
        background-color: #2a2a2a;
        padding: 4px 8px;
        border-radius: 5px;
        /* Pushes timer to the far right */
        margin-left: auto;
    }
    /* --- END NEW --- */

    .card-body {
        padding-top: 10px;
        font-size: 0.9em;
    }

    /* --- MODIFIED: Fit Info (Left Aligned) --- */
    .fit-info {
        display: flex;
        /* justify-content: space-between; <-- REMOVED */
        margin-bottom: 5px;
        gap: 5px; /* Added gap */
    }

        .fit-info strong,
        .fit-issues strong {
            color: #aaa;
            flex-shrink: 0; /* Prevent "HULL:" from shrinking */
        }

        .fit-info .placeholder {
            color: #fff;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    /* --- NEW: Card Body Grid --- */
    .card-body-grid {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .fit-details-left {
        flex-grow: 1;
        min-width: 0; /* Prevents flex overflow */
    }

    .fit-ship-right {
        flex-shrink: 0;
    }

    .ship-hull-img {
        width: 64px;
        height: 64px;
    }
    /* --- END NEW --- */


    .fit-issues {
        margin-top: 10px;
        color: #ff8a8a; /* Red for issues */
    }

        .fit-issues .placeholder {
            font-weight: 500;
        }

    .pilot-stats {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #444;
    }

    .stat-item {
        color: #ccc;
    }

    /* --- FC ACTION STYLES (MODIFIED) --- */
    .fc-actions {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #444;
        display: flex;
        gap: 10px;
        justify-content: flex-end; /* --- Align buttons to the right --- */
    }

    .fc-btn {
        /* --- REMOVED flex: 1; --- */
        padding: 6px 10px; /* --- Adjusted padding --- */
        font-size: 1.1em; /* --- Adjusted font size for emoji --- */
        font-weight: 600;
        color: #fff;
        text-align: center;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        line-height: 1; /* --- Ensure emoji fits well --- */
    }

    .btn-approve {
        background-color: #339966;
    }

        .btn-approve:hover {
            background-color: #3caa73;
        }

    .btn-deny {
        background-color: #993333;
    }

        .btn-deny:hover {
            background-color: #b33a3a;
        }
    /* --- END MODIFIED STYLES --- */

</style>
{% endblock %}


{% block content %}
<!--
This container will be the target for our live polling.
It will be filled by the partial template on page load.
-->
<div class="waitlist-container" id="waitlist-container-live">
    <!-- --- FIX: Updated include path --- -->
    {% include "_waitlist_columns.html" %}
</div>
{% endblock %}


<!-- --- NEW JAVASCRIPT BLOCK --- -->
{% block scripts %}
<script>
    // This script block will handle both FC actions and the new timer/polling

    // --- CSRF Token for all API requests ---
    const csrfToken = "{{ csrf_token }}";

    // --- Waitlist Container ---
    const waitlistContainer = document.getElementById('waitlist-container-live');

    // ===================================
    // 1. FC ACTION (APPROVE/DENY)
    // ===================================

    // We attach the listener to the container, not the buttons.
    // This is "event delegation" and it's essential for
    // dynamically added content.
    waitlistContainer.addEventListener('click', function(event) {
        // Find the button that was clicked
        const button = event.target.closest('.fc-btn');

        // If the click wasn't on a button, do nothing
        if (!button) {
            return;
        }

        const fitId = button.dataset.fitId;
        const action = button.dataset.action;
        const card = document.getElementById(`fit-card-${fitId}`);

        if (!fitId || !action) {
            return;
        }

        // Disable button to prevent double clicks
        button.disabled = true;

        // Prepare data for the API
        const formData = new FormData();
        formData.append('fit_id', fitId);
        formData.append('action', action);

        // Send the API request
        fetch("{% url 'waitlist:api_update_fit_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest' // Helps Django identify AJAX
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Success! Remove the card from the view.
                if (card) {
                    card.style.transition = 'opacity 0.3s ease';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                }
            } else {
                // Handle error (e.g., show a message)
                console.error('Failed to update fit:', data.message);
                button.disabled = false; // Re-enable button on failure
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            button.disabled = false; // Re-enable button on failure
        });
    });

    // ===================================
    // 2. WAITLIST TIMER (Updates every 30s)
    // ===================================

    function updateWaitTimers() {
        const now_utc = new Date();

        waitlistContainer.querySelectorAll('.fit-card').forEach(card => {
            const timerElement = card.querySelector('.wait-timer');
            if (!timerElement) return;

            const submittedISO = card.dataset.submittedTime;
            if (!submittedISO) return;

            const submittedDate = new Date(submittedISO);

            // Calculate difference in minutes
            const diffMs = now_utc - submittedDate;
            const diffMins = Math.floor(diffMs / 60000); // 60 * 1000

            if (diffMins < 0) {
                timerElement.textContent = "0m";
            } else {
                timerElement.textContent = `${diffMins}m`;
            }
        });
    }

    // Run timers on page load
    updateWaitTimers();
    // And run them again every 30 seconds
    setInterval(updateWaitTimers, 30000);


    // ===================================
    // 3. LIVE POLLING (Updates every 5s)
    // ===================================

    function fetchLatestWaitlist() {
        fetch("{% url 'waitlist:api_get_waitlist_html' %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('Waitlist fetch failed.');
        })
        .then(html => {
            // This is the key:
            // 1. We get the current scroll position
            const scrollY = window.scrollY;

            // 2. We replace the *entire* HTML of the container
            waitlistContainer.innerHTML = html;

            // 3. We re-run the timer function immediately
            updateWaitTimers();

            // 4. We restore the scroll position so the user's
            //    screen doesn't jump.
            window.scrollTo(0, scrollY);
        })
        .catch(error => {
            // Don't show an error, just log it.
            // This could happen if the waitlist closes.
            console.warn('Live update poll failed:', error.message);
        });
    }

    // Start the live polling, 5 seconds after page load
    setTimeout(() => {
        fetchLatestWaitlist(); // Run once
        setInterval(fetchLatestWaitlist, 5000); // Then run every 5s
    }, 5000);

</script>
{% endblock %}
<!-- --- END NEW JAVASCRIPT --- -->